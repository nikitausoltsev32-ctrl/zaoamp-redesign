# Калькулятор доставки - Документация

## Обзор

Калькулятор автоматически рассчитывает стоимость доставки мраморной крошки по России через транспортную компанию "Деловые Линии".

## Основные возможности

### 1. Автоматическое разбиение по грузовикам

**Проблема**: Максимальная грузоподъемность одного грузовика — 20 тонн.

**Решение**: При превышении лимита груз автоматически распределяется по нескольким машинам:

- Вес 25т → 2 грузовика (20т + 5т)
- Вес 45т → 3 грузовика (20т + 20т + 5т)
- Вес 100т → 5 грузовиков (20т × 5)

### 2. Расчет стоимости

Для каждого грузовика делается **отдельный расчет** через API Деловых Линий.

### 3. Наценка 10%

К базовой стоимости от транспортной компании автоматически добавляется скрытая наценка 10%.

## API Endpoints

### POST /api/delivery/calculate

Расчет стоимости доставки.

**Request:**
```json
{
  "derivalCity": "ekaterinburg",
  "arrivalCity": "moscow",
  "weight": 35,
  "volume": 17.5
}
```

**Response:**
```json
{
  "totalWeight": 35,
  "trucksCount": 2,
  "trucks": [
    {
      "number": 1,
      "weight": 20,
      "price": 132000,
      "deliveryDays": "7-10"
    },
    {
      "number": 2,
      "weight": 15,
      "price": 99000,
      "deliveryDays": "7-10"
    }
  ],
  "totalPrice": 231000,
  "splitByTrucks": true,
  "warning": "Груз разделен на 2 грузовика (макс. 20т каждый)"
}
```

### GET /api/delivery/cities

Получить список городов доставки.

## География доставки

Деловые Линии работают по всей России (500+ городов):

| Регион | Базовый тариф | Срок доставки |
|--------|---------------|---------------|
| Екатеринбург | 1,500₽/т | 1-2 дня |
| Свердловская обл. | 2,000₽/т | 2-3 дня |
| Урал | 2,500₽/т | 3-5 дней |
| Приволжье | 4,500₽/т | 5-7 дней |
| Москва | 6,000₽/т | 7-10 дней |
| Санкт-Петербург | 6,500₽/т | 7-10 дней |
| Дальний Восток | 13,000₽/т | 21-30 дней |

## Конфигурация

### Переменные окружения

Создайте файл `.env.local`:

```bash
# API ключ Деловых Линий
DELLIN_API_KEY=your_api_key_here
```

## Использование в коде

```typescript
import type { DeliveryCalculationRequest } from '@/types/delivery'

const response = await fetch('/api/delivery/calculate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    derivalCity: 'ekaterinburg',
    arrivalCity: 'moscow',
    weight: 35
  } as DeliveryCalculationRequest)
})

const data = await response.json()
console.log(`Всего грузовиков: ${data.trucksCount}`)
console.log(`Общая стоимость: ${data.totalPrice}₽`)
```

## Логика работы

```
Запрос на расчет (вес W)
         |
         ↓
    W > 20т?
    /      \
  Да        Нет
  |          |
  ↓          ↓
Разделить  1 грузовик
на N машин
  |
  ↓
Для каждой машины:
  - API запрос к Деловым Линиям
  - Получить базовую цену
  - Добавить наценку 10%
  |
  ↓
Суммировать все грузовики
```

## Известные ограничения

1. **Максимальный вес на грузовик**: 20 тонн
2. **Негабарит**: Груз > 5 тонн считается негабаритным
3. **Fallback**: При отсутствии API ключа используются примерные расчеты
